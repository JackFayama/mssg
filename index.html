<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zuri Stays KE - Your Home Away From Home</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
    <style>
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .modal-backdrop {
            backdrop-filter: blur(4px);
        }
        
        .carousel-container {
            position: relative;
            overflow: hidden;
        }
        
        .carousel-track {
            display: flex;
            transition: transform 0.3s ease;
        }
        
        .carousel-slide {
            min-width: 100%;
            flex-shrink: 0;
        }

        /* Hide scrollbars but keep scrollability */
        .scrollable-content {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* Internet Explorer 10+ */
        }
        
        .scrollable-content::-webkit-scrollbar {
            display: none; /* WebKit */
        }

        /* Modal z-index hierarchy */
        .modal-base { z-index: 1000; }
        .modal-secondary { z-index: 1100; }
        .modal-tertiary { z-index: 1200; }
        .modal-quaternary { z-index: 1300; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script>
        // Global state management
        const AppState = {
            currentUser: null,
            listings: [],
            bookings: [],
            reviews: [],
            filteredListings: [],
            searchQuery: '',
            modals: {
                auth: null,
                booking: null,
                host: false,
                bookings: false,
                review: null,
                profile: false,
                reviews: null,
                myListings: false,
                support: false
            }
        };

        // Storage utilities
        const StorageKeys = {
            USERS: 'zuri_users',
            LISTINGS: 'zuri_listings',
            BOOKINGS: 'zuri_bookings',
            REVIEWS: 'zuri_reviews',
            CURRENT_USER: 'zuri_current_user'
        };

        const getStorageItem = (key) => {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : null;
            } catch {
                return null;
            }
        };

        const setStorageItem = (key, value) => {
            try {
                localStorage.setItem(key, JSON.stringify(value));
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        };

        // Countries data with all worldwide countries
        const countries = [
            { name: "Afghanistan", code: "+93" },
            { name: "Albania", code: "+355" },
            { name: "Algeria", code: "+213" },
            { name: "Andorra", code: "+376" },
            { name: "Angola", code: "+244" },
            { name: "Argentina", code: "+54" },
            { name: "Armenia", code: "+374" },
            { name: "Australia", code: "+61" },
            { name: "Austria", code: "+43" },
            { name: "Azerbaijan", code: "+994" },
            { name: "Bahrain", code: "+973" },
            { name: "Bangladesh", code: "+880" },
            { name: "Belarus", code: "+375" },
            { name: "Belgium", code: "+32" },
            { name: "Belize", code: "+501" },
            { name: "Benin", code: "+229" },
            { name: "Bhutan", code: "+975" },
            { name: "Bolivia", code: "+591" },
            { name: "Bosnia and Herzegovina", code: "+387" },
            { name: "Botswana", code: "+267" },
            { name: "Brazil", code: "+55" },
            { name: "Brunei", code: "+673" },
            { name: "Bulgaria", code: "+359" },
            { name: "Burkina Faso", code: "+226" },
            { name: "Burundi", code: "+257" },
            { name: "Cambodia", code: "+855" },
            { name: "Cameroon", code: "+237" },
            { name: "Canada", code: "+1" },
            { name: "Cape Verde", code: "+238" },
            { name: "Central African Republic", code: "+236" },
            { name: "Chad", code: "+235" },
            { name: "Chile", code: "+56" },
            { name: "China", code: "+86" },
            { name: "Colombia", code: "+57" },
            { name: "Comoros", code: "+269" },
            { name: "Congo", code: "+242" },
            { name: "Costa Rica", code: "+506" },
            { name: "Croatia", code: "+385" },
            { name: "Cuba", code: "+53" },
            { name: "Cyprus", code: "+357" },
            { name: "Czech Republic", code: "+420" },
            { name: "Denmark", code: "+45" },
            { name: "Djibouti", code: "+253" },
            { name: "Dominican Republic", code: "+1" },
            { name: "Ecuador", code: "+593" },
            { name: "Egypt", code: "+20" },
            { name: "El Salvador", code: "+503" },
            { name: "Equatorial Guinea", code: "+240" },
            { name: "Eritrea", code: "+291" },
            { name: "Estonia", code: "+372" },
            { name: "Ethiopia", code: "+251" },
            { name: "Fiji", code: "+679" },
            { name: "Finland", code: "+358" },
            { name: "France", code: "+33" },
            { name: "Gabon", code: "+241" },
            { name: "Gambia", code: "+220" },
            { name: "Georgia", code: "+995" },
            { name: "Germany", code: "+49" },
            { name: "Ghana", code: "+233" },
            { name: "Greece", code: "+30" },
            { name: "Guatemala", code: "+502" },
            { name: "Guinea", code: "+224" },
            { name: "Guinea-Bissau", code: "+245" },
            { name: "Guyana", code: "+592" },
            { name: "Haiti", code: "+509" },
            { name: "Honduras", code: "+504" },
            { name: "Hungary", code: "+36" },
            { name: "Iceland", code: "+354" },
            { name: "India", code: "+91" },
            { name: "Indonesia", code: "+62" },
            { name: "Iran", code: "+98" },
            { name: "Iraq", code: "+964" },
            { name: "Ireland", code: "+353" },
            { name: "Israel", code: "+972" },
            { name: "Italy", code: "+39" },
            { name: "Jamaica", code: "+1" },
            { name: "Japan", code: "+81" },
            { name: "Jordan", code: "+962" },
            { name: "Kazakhstan", code: "+7" },
            { name: "Kenya", code: "+254" },
            { name: "Kuwait", code: "+965" },
            { name: "Kyrgyzstan", code: "+996" },
            { name: "Laos", code: "+856" },
            { name: "Latvia", code: "+371" },
            { name: "Lebanon", code: "+961" },
            { name: "Lesotho", code: "+266" },
            { name: "Liberia", code: "+231" },
            { name: "Libya", code: "+218" },
            { name: "Lithuania", code: "+370" },
            { name: "Luxembourg", code: "+352" },
            { name: "Madagascar", code: "+261" },
            { name: "Malawi", code: "+265" },
            { name: "Malaysia", code: "+60" },
            { name: "Maldives", code: "+960" },
            { name: "Mali", code: "+223" },
            { name: "Malta", code: "+356" },
            { name: "Mauritania", code: "+222" },
            { name: "Mauritius", code: "+230" },
            { name: "Mexico", code: "+52" },
            { name: "Moldova", code: "+373" },
            { name: "Monaco", code: "+377" },
            { name: "Mongolia", code: "+976" },
            { name: "Montenegro", code: "+382" },
            { name: "Morocco", code: "+212" },
            { name: "Mozambique", code: "+258" },
            { name: "Myanmar", code: "+95" },
            { name: "Namibia", code: "+264" },
            { name: "Nepal", code: "+977" },
            { name: "Netherlands", code: "+31" },
            { name: "New Zealand", code: "+64" },
            { name: "Nicaragua", code: "+505" },
            { name: "Niger", code: "+227" },
            { name: "Nigeria", code: "+234" },
            { name: "North Korea", code: "+850" },
            { name: "Norway", code: "+47" },
            { name: "Oman", code: "+968" },
            { name: "Pakistan", code: "+92" },
            { name: "Panama", code: "+507" },
            { name: "Papua New Guinea", code: "+675" },
            { name: "Paraguay", code: "+595" },
            { name: "Peru", code: "+51" },
            { name: "Philippines", code: "+63" },
            { name: "Poland", code: "+48" },
            { name: "Portugal", code: "+351" },
            { name: "Qatar", code: "+974" },
            { name: "Romania", code: "+40" },
            { name: "Russia", code: "+7" },
            { name: "Rwanda", code: "+250" },
            { name: "Saudi Arabia", code: "+966" },
            { name: "Senegal", code: "+221" },
            { name: "Serbia", code: "+381" },
            { name: "Seychelles", code: "+248" },
            { name: "Sierra Leone", code: "+232" },
            { name: "Singapore", code: "+65" },
            { name: "Slovakia", code: "+421" },
            { name: "Slovenia", code: "+386" },
            { name: "Somalia", code: "+252" },
            { name: "South Africa", code: "+27" },
            { name: "South Korea", code: "+82" },
            { name: "South Sudan", code: "+211" },
            { name: "Spain", code: "+34" },
            { name: "Sri Lanka", code: "+94" },
            { name: "Sudan", code: "+249" },
            { name: "Suriname", code: "+597" },
            { name: "Sweden", code: "+46" },
            { name: "Switzerland", code: "+41" },
            { name: "Syria", code: "+963" },
            { name: "Taiwan", code: "+886" },
            { name: "Tajikistan", code: "+992" },
            { name: "Tanzania", code: "+255" },
            { name: "Thailand", code: "+66" },
            { name: "Togo", code: "+228" },
            { name: "Tunisia", code: "+216" },
            { name: "Turkey", code: "+90" },
            { name: "Turkmenistan", code: "+993" },
            { name: "Uganda", code: "+256" },
            { name: "Ukraine", code: "+380" },
            { name: "United Arab Emirates", code: "+971" },
            { name: "United Kingdom", code: "+44" },
            { name: "United States", code: "+1" },
            { name: "Uruguay", code: "+598" },
            { name: "Uzbekistan", code: "+998" },
            { name: "Venezuela", code: "+58" },
            { name: "Vietnam", code: "+84" },
            { name: "Yemen", code: "+967" },
            { name: "Zambia", code: "+260" },
            { name: "Zimbabwe", code: "+263" }
        ];

        // Valid transaction ID pattern: TG4 followed by 7 digits/letters
        const validateTransactionId = (transactionId) => {
            const pattern = /^TG4[A-Z0-9]{7}$/i;
            return pattern.test(transactionId);
        };

        // Currency conversion
        const USD_TO_KES_RATE = 150;

        const convertUSDToKES = async (usdAmount) => {
            try {
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                const data = await response.json();
                const rate = data.rates.KES || USD_TO_KES_RATE;
                return Math.round(usdAmount * rate);
            } catch {
                return Math.round(usdAmount * USD_TO_KES_RATE);
            }
        };

        const formatCurrency = (amount, currency) => {
            const formatter = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: currency,
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
            });
            return formatter.format(amount);
        };

        // Validation utilities
        const validateEmail = (email) => {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        };

        const validatePassword = (password) => {
            return password.length >= 6;
        };

        // Email service
        const sendBookingConfirmation = async (bookingData) => {
            try {
                await emailjs.send(
                    'service_rql9o4s',
                    'template_pg1pvjb',
                    {
                        to_name: 'Zuri Stays Admin',
                        from_name: bookingData.userName,
                        user_email: bookingData.userEmail,
                        listing_name: bookingData.listingName,
                        check_in: bookingData.checkIn,
                        check_out: bookingData.checkOut,
                        total_usd: bookingData.totalUSD,
                        total_kes: bookingData.totalKES,
                        transaction_id: bookingData.transactionId,
                    },
                    'W0Zng8g6Zol6lMWU9'
                );
                return true;
            } catch (error) {
                console.error('Email send failed:', error);
                return false;
            }
        };

        // Initialize storage with sample data
        const initializeStorage = () => {
            if (!getStorageItem(StorageKeys.LISTINGS)) {
                const sampleListings = [
                    {
    id: '1',
    name: 'Luxurious Apartment in Westlands',
    location: 'Westlands, Nairobi',
    price: 85,
    images: ['p1.png', 'p2.png', 'p1.png'],
    features: ['bed', 'kitchen', 'wifi', 'tv', 'shower', 'parking'],
    hostId: '1',
    hostName: 'Juliet Mbumbu',
    hostProfilePicture: 'p1.png',
    description: 'Beautiful modern apartment with stunning city views',
    status: 'active',
    averageRating: 4.8,
    totalReviews: 24
},
{
    id: '2',
    name: 'Cozy Studio in Karen',
    location: 'Karen, Nairobi',
    price: 65,
    images: ['l2.png'],
    features: ['bed', 'kitchen', 'wifi', 'shower'],
    hostId: '2',
    hostName: 'Michael Chen',
    hostProfilePicture: 'p2.png',
    description: 'Perfect for couples and solo travelers',
    status: 'active',
    averageRating: 4.6,
    totalReviews: 18
},
{
    id: '3',
    name: 'Penthouse Suite in Kilimani',
    location: 'Kilimani, Nairobi',
    price: 120,
    images: ['l3.png'],
    features: ['bed', 'kitchen', 'wifi', 'tv', 'shower', 'parking', 'pool', 'gym'],
    hostId: '3',
    hostName: 'Emma Rodriguez',
    hostProfilePicture: 'p3.png',
    description: 'Luxury penthouse with premium amenities',
    status: 'active',
    averageRating: 4.9,
    totalReviews: 31
},
{
    id: '4',
    name: 'Modern Loft in CBD',
    location: 'CBD, Nairobi',
    price: 95,
    images: ['l4.png'],
    features: ['bed', 'kitchen', 'wifi', 'tv', 'shower', 'parking'],
    hostId: 'admin',
    hostName: 'James Wilson',
    hostProfilePicture: 'p2.png',
    description: 'Contemporary loft in the heart of the city',
    status: 'active',
    averageRating: 4.7,
    totalReviews: 22
}
                ];
                setStorageItem(StorageKeys.LISTINGS, sampleListings);
            }

            if (!getStorageItem(StorageKeys.REVIEWS)) {
                const sampleReviews = [
                    {
                        id: '1',
                        userId: 'sample',
                        listingId: '1',
                        bookingId: 'sample',
                        rating: 5,
                        comment: 'Amazing place! The host was very accommodating and the location is perfect. The apartment was exactly as described and even better in person. Would definitely stay again!',
                        createdAt: '2024-01-15',
                        userName: 'John Doe'
                    },
                    {
                        id: '2',
                        userId: 'sample2',
                        listingId: '1',
                        bookingId: 'sample2',
                        rating: 4,
                        comment: 'Great apartment with all amenities. The kitchen was well-equipped and the bed was very comfortable. Only minor issue was the Wi-Fi speed, but overall excellent stay.',
                        createdAt: '2024-01-10',
                        userName: 'Jane Smith'
                    },
                    {
                        id: '3',
                        userId: 'sample3',
                        listingId: '1',
                        bookingId: 'sample3',
                        rating: 5,
                        comment: 'Sarah was an excellent host! The apartment is in a prime location with easy access to restaurants and shopping. Everything was clean and well-maintained.',
                        createdAt: '2024-01-05',
                        userName: 'Mike Johnson'
                    }
                ];
                setStorageItem(StorageKeys.REVIEWS, sampleReviews);
            }

            if (!getStorageItem(StorageKeys.USERS)) {
                setStorageItem(StorageKeys.USERS, []);
            }
            if (!getStorageItem(StorageKeys.BOOKINGS)) {
                setStorageItem(StorageKeys.BOOKINGS, []);
            }
        };

        // Load data
        const loadData = () => {
            const savedUser = getStorageItem(StorageKeys.CURRENT_USER);
            const savedListings = getStorageItem(StorageKeys.LISTINGS) || [];
            const savedBookings = getStorageItem(StorageKeys.BOOKINGS) || [];
            const savedReviews = getStorageItem(StorageKeys.REVIEWS) || [];

            if (savedUser) AppState.currentUser = savedUser;
            AppState.listings = savedListings.filter(listing => listing.status === 'active');
            AppState.bookings = savedBookings;
            AppState.reviews = savedReviews;
            AppState.filteredListings = AppState.listings;
        };

        // Search functionality
        const handleSearch = (query) => {
            AppState.searchQuery = query;
            if (query.trim()) {
                AppState.filteredListings = AppState.listings.filter(listing =>
                    listing.name.toLowerCase().includes(query.toLowerCase()) ||
                    listing.location.toLowerCase().includes(query.toLowerCase()) ||
                    listing.hostName.toLowerCase().includes(query.toLowerCase())
                );
            } else {
                AppState.filteredListings = AppState.listings;
            }
            render();
        };

        // Authentication
        const handleLogin = (user) => {
            AppState.currentUser = user;
            setStorageItem(StorageKeys.CURRENT_USER, user);
            AppState.modals.auth = null;
            render();
        };

        const handleLogout = () => {
            AppState.currentUser = null;
            localStorage.removeItem(StorageKeys.CURRENT_USER);
            render();
        };

        // Booking
        const handleBookNow = (listing) => {
            if (!AppState.currentUser) {
                AppState.modals.auth = 'login';
                render();
                return;
            }
            AppState.modals.booking = listing;
            render();
        };

        // Modal management
        const closeModal = (modalName) => {
            AppState.modals[modalName] = modalName === 'auth' ? null : false;
            render();
        };

        const showModal = (modalName, data = true) => {
            AppState.modals[modalName] = data;
            render();
        };

        // Component: Header
        const Header = () => {
            return `
                <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
                    <div class="max-w-7xl mx-auto px-3 sm:px-6 lg:px-8">
                        <div class="flex justify-between items-center h-14 sm:h-16">
                            <!-- Logo -->
                            <div class="flex items-center flex-shrink-0">
                                <span class="text-lg sm:text-xl font-bold text-gray-900">Zuri Stays KE</span>
                            </div>

                            <!-- Search - Hidden on mobile, shown on tablet+ -->
                            <div class="hidden md:flex flex-1 max-w-lg mx-4 lg:mx-8">
                                <form onsubmit="handleSearchSubmit(event)" class="relative w-full">
                                    <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                        </svg>
                                    </div>
                                    <input
                                        type="text"
                                        id="searchInput"
                                        value="${AppState.searchQuery}"
                                        oninput="handleSearch(this.value)"
                                        placeholder="Search destinations, hosts..."
                                        class="w-full pl-9 sm:pl-10 pr-4 py-2 text-sm border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-rose-500 focus:border-transparent"
                                    />
                                </form>
                            </div>

                            <!-- User Menu -->
                            <div class="relative flex-shrink-0">
                                ${AppState.currentUser ? `
                                    <div class="relative">
                                        <button
                                            onclick="toggleUserDropdown()"
                                            class="flex items-center space-x-1 sm:space-x-2 bg-white border border-gray-300 rounded-full px-2 sm:px-4 py-1.5 sm:py-2 hover:shadow-md transition-shadow"
                                        >
                                            <span class="text-gray-600">
                                                <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                                                </svg>
                                            </span>
                                            <div class="w-6 h-6 sm:w-8 sm:h-8 bg-rose-500 rounded-full flex items-center justify-center overflow-hidden">
                                                ${AppState.currentUser.profilePicture ? `
                                                    <img src="${AppState.currentUser.profilePicture}" alt="Profile" class="w-full h-full object-cover" />
                                                ` : `
                                                    <svg class="w-3 h-3 sm:w-5 sm:h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                                    </svg>
                                                `}
                                            </div>
                                        </button>

                                        <div id="userDropdown" class="hidden absolute right-0 mt-2 w-56 bg-white border border-gray-200 rounded-xl shadow-lg py-2 z-50">
                                            <div class="px-4 py-2 border-b border-gray-100">
                                                <p class="font-medium text-gray-900 text-sm">${AppState.currentUser.name}</p>
                                                <p class="text-xs text-gray-600">${AppState.currentUser.email}</p>
                                            </div>
                                            <button onclick="showModal('profile')" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center space-x-2">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                                </svg>
                                                <span>Profile</span>
                                            </button>
                                            <button onclick="showModal('bookings')" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center space-x-2">
                                                <span>⭐</span>
                                                <span>My Bookings</span>
                                            </button>
                                            <button onclick="showModal('host')" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center space-x-2">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                </svg>
                                                <span>Become a Host</span>
                                            </button>
                                            <button onclick="showModal('myListings')" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center space-x-2">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                                </svg>
                                                <span>My Listings</span>
                                            </button>
                                            <button onclick="showModal('support')" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center space-x-2">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                                <span>Support</span>
                                            </button>
                                            <hr class="my-2 border-gray-100" />
                                            <button onclick="handleLogout()" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                                                Logout
                                            </button>
                                        </div>
                                    </div>
                                ` : `
                                    <div class="flex items-center space-x-2 sm:space-x-4">
                                        <button onclick="showModal('auth', 'login')" class="text-gray-700 hover:text-gray-900 font-medium text-sm">
                                            Sign In
                                        </button>
                                        <button onclick="showModal('auth', 'register')" class="bg-rose-500 text-white px-3 sm:px-4 py-1.5 sm:py-2 rounded-full hover:bg-rose-600 transition-colors text-sm font-medium">
                                            Sign Up
                                        </button>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>

                    <!-- Mobile Search Bar -->
                    <div class="md:hidden border-t border-gray-200 px-3 py-3">
                        <form onsubmit="handleSearchSubmit(event)" class="relative">
                            <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                            <input
                                type="text"
                                id="mobileSearchInput"
                                value="${AppState.searchQuery}"
                                oninput="handleSearch(this.value)"
                                placeholder="Search destinations, hosts, or properties..."
                                class="w-full pl-9 pr-4 py-2 text-sm border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-rose-500 focus:border-transparent"
                            />
                        </form>
                    </div>
                </header>
            `;
        };

        // Component: Listing Card
        const ListingCard = (listing) => {
            return `
                <div class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition-shadow duration-300">
                    <!-- Image Carousel -->
                    <div class="relative h-64 bg-gray-200 carousel-container">
                        ${listing.images.length > 0 ? `
                            <div class="carousel-track" id="carousel-${listing.id}" style="transform: translateX(0%)">
                                ${listing.images.map(image => `
                                    <div class="carousel-slide">
                                        <img src="${image}" alt="${listing.name}" class="w-full h-64 object-cover" />
                                    </div>
                                `).join('')}
                            </div>
                            ${listing.images.length > 1 ? `
                                <button onclick="prevImage('${listing.id}')" class="absolute left-2 top-1/2 -translate-y-1/2 bg-white bg-opacity-80 hover:bg-opacity-100 rounded-full p-2 shadow-lg transition-all">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                    </svg>
                                </button>
                                <button onclick="nextImage('${listing.id}')" class="absolute right-2 top-1/2 -translate-y-1/2 bg-white bg-opacity-80 hover:bg-opacity-100 rounded-full p-2 shadow-lg transition-all">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                </button>
                                <div class="absolute bottom-2 left-1/2 -translate-x-1/2 flex space-x-1">
                                    ${listing.images.map((_, index) => `
                                        <button onclick="setImageIndex('${listing.id}', ${index})" class="w-2 h-2 rounded-full transition-all ${index === 0 ? 'bg-white' : 'bg-white bg-opacity-50'}"></button>
                                    `).join('')}
                                </div>
                            ` : ''}
                        ` : ''}
                    </div>

                    <div class="p-6">
                        <!-- Header -->
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-900 mb-1">${listing.name}</h3>
                                <div class="flex items-center text-gray-600 text-sm">
                                    <span>${listing.location}</span>
                                </div>
                            </div>
                            ${listing.averageRating ? `
                                <div class="flex items-center bg-gray-50 rounded-full px-2 py-1">
                                    <span class="text-yellow-500 mr-1">⭐</span>
                                    <span class="text-sm font-medium">${listing.averageRating}</span>
                                </div>
                            ` : ''}
                        </div>

                        <!-- Host Info -->
                        <div class="flex items-center mb-4">
                            <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center mr-3 overflow-hidden">
                                ${listing.hostProfilePicture ? `
                                    <img src="${listing.hostProfilePicture}" alt="${listing.hostName}" class="w-full h-full object-cover" />
                                ` : `
                                    <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                `}
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-900">${listing.hostName}</p>
                                <p class="text-xs text-gray-600">Host</p>
                            </div>
                        </div>

                        <!-- Features -->
                        <div class="flex flex-wrap gap-2 mb-4">
                            ${listing.features.map(feature => `
                                <div class="bg-blue-50 text-blue-700 px-2 py-1 rounded-full text-xs">
                                    <span class="capitalize">${feature}</span>
                                </div>
                            `).join('')}
                        </div>

                        <!-- Price and Book Button -->
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <span class="text-xl font-bold text-gray-900">$${listing.price}</span>
                                <span class="text-gray-600 text-sm"> / night</span>
                            </div>
                            <button onclick="handleBookNow(${JSON.stringify(listing).replace(/"/g, '&quot;')})" class="bg-rose-500 text-white px-6 py-2 rounded-full hover:bg-rose-600 transition-colors font-medium">
                                Book Now
                            </button>
                        </div>

                        <!-- Reviews section -->
                        ${listing.totalReviews ? `
                            <div class="pt-3 border-t border-gray-100">
                                <div class="flex items-center justify-between">
                                    <p class="text-sm text-gray-600">
                                        ${listing.totalReviews} review${listing.totalReviews !== 1 ? 's' : ''}
                                    </p>
                                    <button onclick="showModal('reviews', ${JSON.stringify(listing).replace(/"/g, '&quot;')})" class="text-rose-500 hover:text-rose-600 text-sm font-medium">
                                        Read Reviews
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        };

        // Component: Auth Modal
        const AuthModal = () => {
            if (!AppState.modals.auth) return '';
            
            const type = AppState.modals.auth;
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center modal-base p-4">
                    <div class="bg-white rounded-xl shadow-xl w-full max-w-sm max-h-[90vh] scrollable-content overflow-y-auto">
                        <div class="p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-2xl font-bold text-gray-900">
                                    ${type === 'login' ? 'Sign In' : 'Sign Up'}
                                </h2>
                                <button onclick="closeModal('auth')" class="text-gray-400 hover:text-gray-600 transition-colors">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>

                            <form onsubmit="handleAuthSubmit(event, '${type}')" class="space-y-4">
                                ${type === 'register' ? `
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                                        <input type="text" name="name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-500" placeholder="Enter your full name" />
                                    </div>
                                ` : ''}

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                    <input type="email" name="email" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-500" placeholder="Enter your email" />
                                </div>

                                ${type === 'register' ? `
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Country</label>
                                        <select name="country" onchange="updatePhoneCode(this)" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-500">
                                            <option value="">Select your country</option>
                                            ${countries.map(country => `
                                                <option value="${country.name}" data-code="${country.code}">${country.name}</option>
                                            `).join('')}
                                        </select>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                                        <input type="tel" name="phone" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-500" placeholder="Phone number with country code" />
                                    </div>
                                ` : ''}

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                    <input type="password" name="password" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-500" placeholder="Enter your password" />
                                </div>

                                ${type === 'register' ? `
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
                                        <input type="password" name="confirmPassword" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-500" placeholder="Confirm your password" />
                                    </div>
                                ` : ''}

                                <button type="submit" class="w-full bg-rose-500 text-white py-2 px-4 rounded-lg hover:bg-rose-600 transition-colors">
                                    ${type === 'login' ? 'Sign In' : 'Sign Up'}
                                </button>
                            </form>

                            <div class="mt-6 text-center">
                                <button onclick="closeModal('auth')" class="text-gray-600 hover:text-gray-800 transition-colors">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        // Component: Profile Modal
        const ProfileModal = () => {
            if (!AppState.modals.profile) return '';
            
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center modal-base p-4">
                    <div class="bg-white rounded-xl shadow-xl w-full max-w-sm max-h-[90vh] scrollable-content overflow-y-auto">
                        <div class="p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-2xl font-bold text-gray-900">Profile</h2>
                                <button onclick="closeModal('profile')" class="text-gray-400 hover:text-gray-600 transition-colors">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>

                            <div class="space-y-6">
                                <!-- Profile Picture -->
                                <div class="text-center">
                                    <div class="relative inline-block">
                                        <div class="w-24 h-24 bg-gray-300 rounded-full flex items-center justify-center mx-auto mb-4 overflow-hidden cursor-pointer" onclick="document.getElementById('profilePictureInput').click()">
                                            ${AppState.currentUser.profilePicture ? `
                                                <img src="${AppState.currentUser.profilePicture}" alt="Profile" class="w-full h-full object-cover" />
                                            ` : `
                                                <svg class="w-12 h-12 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                                </svg>
                                            `}
                                        </div>
                                        <input type="file" id="profilePictureInput" accept="image/*" onchange="handleProfilePictureUpload(event)" class="hidden" />
                                        <button onclick="document.getElementById('profilePictureInput').click()" class="absolute bottom-0 right-0 bg-rose-500 text-white rounded-full p-2 hover:bg-rose-600 transition-colors">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            </svg>
                                        </button>
                                    </div>
                                    <p class="text-sm text-gray-600">Click to upload profile picture</p>
                                </div>

                                <!-- User Info -->
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                                        <p class="text-gray-900">${AppState.currentUser.name}</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                        <p class="text-gray-900">${AppState.currentUser.email}</p>
                                    </div>
                                    ${AppState.currentUser.country ? `
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Country</label>
                                            <p class="text-gray-900">${AppState.currentUser.country}</p>
                                        </div>
                                    ` : ''}
                                    ${AppState.currentUser.phone ? `
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                                            <p class="text-gray-900">${AppState.currentUser.phone}</p>
                                        </div>
                                    ` : ''}
                                </div>

                                <button onclick="closeModal('profile')" class="w-full bg-rose-500 text-white py-2 px-4 rounded-lg hover:bg-rose-600 transition-colors">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        // Component: Bookings Modal
        const BookingsModal = () => {
            if (!AppState.modals.bookings) return '';
            
            const userBookings = AppState.bookings.filter(booking => booking.userId === AppState.currentUser?.id);
            
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center modal-base p-4">
                    <div class="bg-white rounded-xl shadow-xl w-full max-w-sm max-h-[90vh] scrollable-content overflow-y-auto">
                        <div class="p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-2xl font-bold text-gray-900">My Bookings</h2>
                                <button onclick="closeModal('bookings')" class="text-gray-400 hover:text-gray-600 transition-colors">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>

                            <div class="space-y-4">
                                ${userBookings.length > 0 ? userBookings.map(booking => `
                                    <div class="border border-gray-200 rounded-lg p-4">
                                        <h3 class="font-semibold text-gray-900 mb-2">${booking.listingName}</h3>
                                        <div class="space-y-1 text-sm text-gray-600">
                                            <p>Location: ${booking.location}</p>
                                            <p>Check-in: ${booking.checkIn}</p>
                                            <p>Check-out: ${booking.checkOut}</p>
                                            <p>Nights: ${booking.nights}</p>
                                            <p>Total: ${formatCurrency(booking.totalUSD, 'USD')} (${formatCurrency(booking.totalKES, 'KES')})</p>
                                            <p>Status: <span class="font-medium text-green-600">${booking.status}</span></p>
                                        </div>
                                    </div>
                                `).join('') : '<p class="text-gray-600 text-center py-8">No bookings yet.</p>'}
                            </div>

                            <button onclick="closeModal('bookings')" class="w-full mt-6 bg-rose-500 text-white py-2 px-4 rounded-lg hover:bg-rose-600 transition-colors">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };

        // Component: Host Modal
        const HostModal = () => {
            if (!AppState.modals.host) return '';
            
            const features = [
                'bed', 'kitchen', 'wifi', 'tv', 'shower', 'parking', 'pool', 'gym', 'balcony', 'garden',
                'air conditioning', 'heating', 'washing machine', 'dryer', 'dishwasher', 'microwave',
                'refrigerator', 'coffee maker', 'toaster', 'iron', 'hair dryer', 'towels', 'bed linens',
                'soap', 'toilet paper', 'shampoo', 'hot water', 'lockbox', 'hangers', 'laptop workspace',
                'tv with standard cable', 'sound system', 'books and reading material', 'board games',
                'exercise equipment', 'pool table', 'piano', 'fireplace', 'patio', 'bbq grill',
                'outdoor furniture', 'beach access', 'ski access', 'lake access', 'waterfront',
                'mountain view', 'city view', 'garden view'
            ];
            
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center modal-base p-4">
                    <div class="bg-white rounded-xl shadow-xl w-full max-w-sm max-h-[90vh] scrollable-content overflow-y-auto">
                        <div class="p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-2xl font-bold text-gray-900">Become a Host</h2>
                                <button onclick="closeModal('host')" class="text-gray-400 hover:text-gray-600 transition-colors">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>

                            <form onsubmit="handleHostSubmit(event)" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Property Name</label>
                                    <input type="text" name="name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-500" placeholder="Enter property name" />
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                                    <input type="text" name="location" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-500" placeholder="City, Area" />
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Price per Night (USD)</label>
                                    <input type="number" name="price" required min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-500" placeholder="Enter price" />
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                    <textarea name="description" required rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-500" placeholder="Describe your property"></textarea>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Property Images</label>
                                    <input type="file" name="images" multiple accept="image/*" onchange="handleImageUpload(event)" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-500" />
                                    <p class="text-xs text-gray-500 mt-1">Select multiple images</p>
                                    <div id="imagePreview" class="mt-2 grid grid-cols-2 gap-2"></div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Features & Amenities</label>
                                    <div class="max-h-32 scrollable-content overflow-y-auto border border-gray-300 rounded-lg p-3">
                                        <div class="grid grid-cols-1 gap-2">
                                            ${features.map(feature => `
                                                <label class="flex items-center space-x-2">
                                                    <input type="checkbox" name="features" value="${feature}" class="rounded border-gray-300 text-rose-500 focus:ring-rose-500" />
                                                    <span class="text-sm capitalize">${feature}</span>
                                                </label>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>

                                <button type="submit" class="w-full bg-rose-500 text-white py-2 px-4 rounded-lg hover:bg-rose-600 transition-colors">
                                    Submit for Review
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
        };

        // Component: My Listings Modal
        const MyListingsModal = () => {
            if (!AppState.modals.myListings) return '';
            
            const allListings = getStorageItem(StorageKeys.LISTINGS) || [];
            const userListings = allListings.filter(listing => listing.hostId === AppState.currentUser?.id);
            
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center modal-base p-4">
                    <div class="bg-white rounded-xl shadow-xl w-full max-w-sm max-h-[90vh] scrollable-content overflow-y-auto">
                        <div class="p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-2xl font-bold text-gray-900">My Listings</h2>
                                <button onclick="closeModal('myListings')" class="text-gray-400 hover:text-gray-600 transition-colors">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>

                            <div class="space-y-4">
                                ${userListings.length > 0 ? userListings.map(listing => `
                                    <div class="border border-gray-200 rounded-lg p-4">
                                        <h3 class="font-semibold text-gray-900 mb-2">${listing.name}</h3>
                                        <div class="space-y-1 text-sm text-gray-600">
                                            <p>Location: ${listing.location}</p>
                                            <p>Price: $${listing.price}/night</p>
                                            <p>Status: <span class="font-medium ${listing.status === 'active' ? 'text-green-600' : 'text-yellow-600'}">${listing.status === 'active' ? 'Active' : 'Under review by admin'}</span></p>
                                        </div>
                                    </div>
                                `).join('') : '<p class="text-gray-600 text-center py-8">No listings yet.</p>'}
                            </div>

                            <button onclick="closeModal('myListings')" class="w-full mt-6 bg-rose-500 text-white py-2 px-4 rounded-lg hover:bg-rose-600 transition-colors">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };

        // Component: Booking Modal
        const BookingModal = () => {
            if (!AppState.modals.booking) return '';
            
            const listing = AppState.modals.booking;
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center modal-base p-4">
                    <div class="bg-white rounded-xl shadow-xl w-full max-w-sm max-h-[90vh] scrollable-content overflow-y-auto">
                        <div class="p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-2xl font-bold text-gray-900">Book Your Stay</h2>
                                <button onclick="closeModal('booking')" class="text-gray-400 hover:text-gray-600 transition-colors">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            
                            <div class="space-y-6">
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h3 class="font-semibold text-gray-900">${listing.name}</h3>
                                    <p class="text-gray-600">${listing.location}</p>
                                    <p class="text-rose-600 font-bold">$${listing.price} / night</p>
                                </div>

                                <form onsubmit="handleBookingSubmit(event, ${JSON.stringify(listing).replace(/"/g, '&quot;')})" class="space-y-4">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Check-in</label>
                                            <input type="date" name="checkIn" onchange="calculateNights()" required min="${new Date().toISOString().split('T')[0]}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-500" />
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Check-out</label>
                                            <input type="date" name="checkOut" onchange="calculateNights()" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-500" />
                                        </div>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Number of Nights</label>
                                        <div class="flex items-center space-x-4">
                                            <button type="button" onclick="changeNights(-1)" class="bg-gray-200 hover:bg-gray-300 rounded-full w-10 h-10 flex items-center justify-center">-</button>
                                            <span id="nightsDisplay" class="text-xl font-semibold">1</span>
                                            <button type="button" onclick="changeNights(1)" class="bg-gray-200 hover:bg-gray-300 rounded-full w-10 h-10 flex items-center justify-center">+</button>
                                        </div>
                                    </div>

                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-700">Total Cost:</span>
                                            <span id="totalCost" class="text-2xl font-bold text-blue-600">$${listing.price}</span>
                                        </div>
                                    </div>

                                    <div class="flex space-x-4">
                                        <button type="button" onclick="closeModal('booking')" class="flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">
                                            Cancel
                                        </button>
                                        <button type="submit" class="flex-1 bg-rose-500 text-white py-2 px-4 rounded-lg hover:bg-rose-600 transition-colors">
                                            Continue Booking
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        // Component: Reviews Modal
        const ReviewsModal = () => {
            if (!AppState.modals.reviews) return '';
            
            const listing = AppState.modals.reviews;
            const listingReviews = AppState.reviews.filter(review => review.listingId === listing.id);
            
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center modal-base p-4">
                    <div class="bg-white rounded-xl shadow-xl w-full max-w-sm max-h-[90vh] scrollable-content overflow-y-auto">
                        <div class="p-6">
                            <div class="flex items-center justify-between mb-6">
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-900">Reviews</h2>
                                    <p class="text-gray-600">${listing.name} - ${listing.location}</p>
                                </div>
                                <button onclick="closeModal('reviews')" class="text-gray-400 hover:text-gray-600 transition-colors">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>

                            <!-- Existing Reviews -->
                            <div class="space-y-4 mb-6">
                                ${listingReviews.length > 0 ? listingReviews.map(review => `
                                    <div class="border border-gray-200 rounded-lg p-4">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="flex items-center space-x-2">
                                                <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center">
                                                    <span class="text-sm font-medium text-gray-600">${review.userName.charAt(0).toUpperCase()}</span>
                                                </div>
                                                <span class="font-medium text-gray-900">${review.userName}</span>
                                            </div>
                                        </div>
                                        <p class="text-gray-700">${review.comment}</p>
                                        <p class="text-xs text-gray-500 mt-2">${new Date(review.createdAt).toLocaleDateString()}</p>
                                    </div>
                                `).join('') : '<p class="text-gray-600 text-center py-8">No reviews yet.</p>'}
                            </div>

                            <!-- Write Review Section -->
                            <div class="border-t border-gray-200 pt-6">
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Write a Review</h3>
                                
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Your Review</label>
                                    <textarea id="reviewText" placeholder="Share your experience..." rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-500"></textarea>
                                </div>

                                <button onclick="handleReviewSubmit('${listing.hostName}')" class="w-full bg-rose-500 text-white px-4 py-2 rounded-lg hover:bg-rose-600 transition-colors">
                                    Submit Review
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        // Component: Support Modal
        const SupportModal = () => {
            if (!AppState.modals.support) return '';
            
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center modal-base p-4">
                    <div class="bg-white rounded-xl shadow-xl w-full max-w-sm">
                        <div class="p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-2xl font-bold text-gray-900">Support</h2>
                                <button onclick="closeModal('support')" class="text-gray-400 hover:text-gray-600 transition-colors">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>

                            <div class="space-y-4">
                                <div class="text-center mb-6">
                                    <div class="text-4xl text-rose-500 mb-3">
                                        <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                        </svg>
                                    </div>
                                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Need Help?</h3>
                                    <p class="text-gray-600">Get in touch with our support team</p>
                                </div>

                                <div class="space-y-4">
                                    <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                                        <svg class="w-6 h-6 text-rose-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                        </svg>
                                        <div>
                                            <p class="text-sm font-medium text-gray-900">Email</p>
                                            <a href="mailto:support@zuristayske.com" class="text-sm text-rose-600 hover:text-rose-700">
                                                support@zuristayske.com
                                            </a>
                                        </div>
                                    </div>

                                    <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                                        <svg class="w-6 h-6 text-rose-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                        </svg>
                                        <div>
                                            <p class="text-sm font-medium text-gray-900">Phone</p>
                                            <a href="tel:+254700123456" class="text-sm text-rose-600 hover:text-rose-700">
                                                +254 700 123 456
                                            </a>
                                        </div>
                                    </div>
                                </div>

                                <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                                    <h4 class="text-sm font-medium text-blue-900 mb-2">Support Hours</h4>
                                    <p class="text-sm text-blue-800">Monday - Friday: 8:00 AM - 6:00 PM EAT</p>
                                    <p class="text-sm text-blue-800">Saturday - Sunday: 9:00 AM - 5:00 PM EAT</p>
                                </div>

                                <button onclick="closeModal('support')" class="w-full bg-rose-500 text-white py-2 px-4 rounded-lg hover:bg-rose-600 transition-colors">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        // Main render function
        const render = () => {
            const app = document.getElementById('app');
            app.innerHTML = `
                ${Header()}
                
                <!-- Main Content -->
                <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <!-- Search Results -->
                    ${AppState.searchQuery ? `
                        <div class="mb-6">
                            <p class="text-gray-600">
                                ${AppState.filteredListings.length} result${AppState.filteredListings.length !== 1 ? 's' : ''} for "${AppState.searchQuery}"
                            </p>
                        </div>
                    ` : ''}

                    <!-- Listings Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        ${AppState.filteredListings.map(listing => ListingCard(listing)).join('')}
                    </div>

                    <!-- Empty State -->
                    ${AppState.filteredListings.length === 0 ? `
                        <div class="text-center py-12">
                            <p class="text-gray-600 text-lg">
                                ${AppState.searchQuery ? 'No listings found matching your search.' : 'No listings available at the moment.'}
                            </p>
                        </div>
                    ` : ''}
                </main>

                <!-- Modals -->
                ${AuthModal()}
                ${ProfileModal()}
                ${BookingModal()}
                ${BookingsModal()}
                ${HostModal()}
                ${MyListingsModal()}
                ${ReviewsModal()}
                ${SupportModal()}
            `;
        };

        // Event handlers
        window.handleSearchSubmit = (event) => {
            event.preventDefault();
        };

        window.toggleUserDropdown = () => {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('hidden');
        };

        window.updatePhoneCode = (select) => {
            const selectedOption = select.options[select.selectedIndex];
            const code = selectedOption.getAttribute('data-code');
            const phoneInput = select.form.phone;
            if (phoneInput && code) {
                phoneInput.value = code + ' ';
            }
        };

        window.handleProfilePictureUpload = (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    AppState.currentUser.profilePicture = e.target.result;
                    
                    // Update user in storage
                    const users = getStorageItem(StorageKeys.USERS) || [];
                    const userIndex = users.findIndex(u => u.id === AppState.currentUser.id);
                    if (userIndex !== -1) {
                        users[userIndex] = AppState.currentUser;
                        setStorageItem(StorageKeys.USERS, users);
                    }
                    setStorageItem(StorageKeys.CURRENT_USER, AppState.currentUser);
                    
                    render();
                };
                reader.readAsDataURL(file);
            }
        };

        window.handleImageUpload = (event) => {
            const files = Array.from(event.target.files);
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';
            
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'w-full h-20 object-cover rounded';
                    preview.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        };

        window.handleHostSubmit = async (event) => {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData);
            
            // Get selected features
            const features = Array.from(event.target.querySelectorAll('input[name="features"]:checked')).map(cb => cb.value);
            
            // Get uploaded images
            const imageFiles = Array.from(event.target.images.files);
            const images = [];
            
            for (const file of imageFiles) {
                const reader = new FileReader();
                const imageData = await new Promise(resolve => {
                    reader.onload = e => resolve(e.target.result);
                    reader.readAsDataURL(file);
                });
                images.push(imageData);
            }
            
            const newListing = {
                id: Date.now().toString(),
                name: data.name,
                location: data.location,
                price: parseInt(data.price),
                description: data.description,
                images: images,
                features: features,
                hostId: AppState.currentUser.id,
                hostName: AppState.currentUser.name,
                hostProfilePicture: AppState.currentUser.profilePicture,
                status: 'pending',
                averageRating: 0,
                totalReviews: 0,
                createdAt: new Date().toISOString()
            };
            
            const listings = getStorageItem(StorageKeys.LISTINGS) || [];
            listings.push(newListing);
            setStorageItem(StorageKeys.LISTINGS, listings);
            
            closeModal('host');
            showSuccessModal('Your property is now under review and will be published once approved by our team.');
        };

        window.handleAuthSubmit = async (event, type) => {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData);

            if (type === 'login') {
                const users = getStorageItem(StorageKeys.USERS) || [];
                const user = users.find(u => u.email === data.email && u.password === data.password);
                if (user) {
                    handleLogin(user);
                } else {
                    showErrorModal('Invalid email or password');
                }
            } else {
                if (data.password !== data.confirmPassword) {
                    showErrorModal('Passwords do not match');
                    return;
                }
                
                const users = getStorageItem(StorageKeys.USERS) || [];
                if (users.find(u => u.email === data.email)) {
                    showErrorModal('Email already exists');
                    return;
                }

                const newUser = {
                    id: Date.now().toString(),
                    name: data.name,
                    email: data.email,
                    country: data.country,
                    phone: data.phone,
                    password: data.password
                };

                users.push(newUser);
                setStorageItem(StorageKeys.USERS, users);
                handleLogin(newUser);
                showSuccessModal('Account created successfully! Welcome to Zuri Stays KE.');
            }
        };

        window.calculateNights = () => {
            const checkIn = document.querySelector('input[name="checkIn"]').value;
            const checkOut = document.querySelector('input[name="checkOut"]').value;
            
            if (checkIn && checkOut) {
                const checkInDate = new Date(checkIn);
                const checkOutDate = new Date(checkOut);
                const timeDiff = checkOutDate.getTime() - checkInDate.getTime();
                const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
                
                if (daysDiff > 0) {
                    document.getElementById('nightsDisplay').textContent = daysDiff;
                    updateTotalCost(daysDiff);
                }
            }
        };

        window.changeNights = (change) => {
            const currentNights = parseInt(document.getElementById('nightsDisplay').textContent);
            const newNights = Math.max(1, currentNights + change);
            document.getElementById('nightsDisplay').textContent = newNights;
            
            // Update checkout date
            const checkInInput = document.querySelector('input[name="checkIn"]');
            if (checkInInput.value) {
                const checkInDate = new Date(checkInInput.value);
                const newCheckOutDate = new Date(checkInDate);
                newCheckOutDate.setDate(checkInDate.getDate() + newNights);
                document.querySelector('input[name="checkOut"]').value = newCheckOutDate.toISOString().split('T')[0];
            }
            
            updateTotalCost(newNights);
        };

        window.updateTotalCost = (nights) => {
            const listing = AppState.modals.booking;
            const total = listing.price * nights;
            document.getElementById('totalCost').textContent = `$${total}`;
        };

        window.handleBookingSubmit = async (event, listing) => {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData);
            const nights = parseInt(document.getElementById('nightsDisplay').textContent);
            const totalUSD = listing.price * nights;
            const totalKES = await convertUSDToKES(totalUSD);

            // Show payment modal
            showPaymentModal(listing, data, nights, totalUSD, totalKES);
        };

        window.showPaymentModal = (listing, bookingData, nights, totalUSD, totalKES) => {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center modal-secondary p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-xl w-full max-w-sm max-h-[90vh] scrollable-content overflow-y-auto">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold text-gray-900">Payment</h2>
                            <button onclick="this.closest('.fixed').remove(); closeModal('booking')" class="text-gray-400 hover:text-gray-600 transition-colors">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="space-y-6">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h3 class="font-semibold text-gray-900 mb-2">Booking Summary</h3>
                                <div class="space-y-1 text-sm">
                                    <div class="flex justify-between">
                                        <span>Property:</span>
                                        <span>${listing.name}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Check-in:</span>
                                        <span>${bookingData.checkIn}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Check-out:</span>
                                        <span>${bookingData.checkOut}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Nights:</span>
                                        <span>${nights}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-green-50 p-4 rounded-lg">
                                <h3 class="font-semibold text-green-900 mb-2">Total Amount</h3>
                                <div class="space-y-1">
                                    <div class="flex justify-between">
                                        <span>USD:</span>
                                        <span class="font-bold">${formatCurrency(totalUSD, 'USD')}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>KES:</span>
                                        <span class="font-bold">${formatCurrency(totalKES, 'KES')}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h3 class="font-semibold text-blue-900 mb-2">Payment Instructions</h3>
                                <p class="text-sm text-blue-800">
                                    Please send the payment to M-PESA Till: <strong>1234</strong>
                                </p>
                                <p class="text-sm text-blue-800 mt-1">
                                    Amount: <strong>${formatCurrency(totalKES, 'KES')}</strong>
                                </p>
                            </div>

                            <form onsubmit="handlePaymentSubmit(event, ${JSON.stringify({listing, bookingData, nights, totalUSD, totalKES}).replace(/"/g, '&quot;')})">
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Transaction ID</label>
                                    <input type="text" name="transactionId" required placeholder="Enter transaction ID (TG4 + 7 characters)" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-500" />
                                </div>

                                <div class="flex space-x-4">
                                    <button type="button" onclick="this.closest('.fixed').remove(); closeModal('booking')" class="flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">
                                        Back
                                    </button>
                                    <button type="submit" class="flex-1 bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">
                                        <span class="confirm-text">Confirm Payment</span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        };

        window.handlePaymentSubmit = async (event, paymentData) => {
            event.preventDefault();
            const formData = new FormData(event.target);
            const transactionId = formData.get('transactionId');
            
            // Show loading state
            const button = event.target.querySelector('button[type="submit"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="confirm-text">Confirming...</span>';
            button.disabled = true;

            if (!validateTransactionId(transactionId)) {
                button.innerHTML = originalText;
                button.disabled = false;
                showErrorModal('Invalid transaction ID. Must start with TG4 followed by 7 digits/letters.');
                return;
            }

            const booking = {
                id: Date.now().toString(),
                userId: AppState.currentUser.id,
                listingId: paymentData.listing.id,
                listingName: paymentData.listing.name,
                location: paymentData.listing.location,
                checkIn: paymentData.bookingData.checkIn,
                checkOut: paymentData.bookingData.checkOut,
                nights: paymentData.nights,
                totalUSD: paymentData.totalUSD,
                totalKES: paymentData.totalKES,
                transactionId,
                status: 'confirmed',
                createdAt: new Date().toISOString()
            };

            const bookings = getStorageItem(StorageKeys.BOOKINGS) || [];
            bookings.push(booking);
            setStorageItem(StorageKeys.BOOKINGS, bookings);
            AppState.bookings = bookings;

            // Send email confirmation
            await sendBookingConfirmation({
                userName: AppState.currentUser.name,
                userEmail: AppState.currentUser.email,
                listingName: paymentData.listing.name,
                checkIn: paymentData.bookingData.checkIn,
                checkOut: paymentData.bookingData.checkOut,
                totalUSD: paymentData.totalUSD,
                totalKES: paymentData.totalKES,
                transactionId
            });

            // Remove payment modal
            event.target.closest('.fixed').remove();
            
            // Show success modal
            showBookingSuccessModal();
        };

        window.showBookingSuccessModal = () => {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center modal-tertiary p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-xl w-full max-w-sm">
                    <div class="p-6 text-center">
                        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center">
                                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Booking Confirmed!</h2>
                        <p class="text-gray-600 mb-6">
                            Your booking has been confirmed and you will receive a confirmation email shortly.
                        </p>
                        <button onclick="this.closest('.fixed').remove(); closeModal('booking')" class="w-full bg-rose-500 text-white py-2 px-4 rounded-lg hover:bg-rose-600 transition-colors">
                            Done
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        };

        window.showSuccessModal = (message) => {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center modal-tertiary p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-xl w-full max-w-sm">
                    <div class="p-6 text-center">
                        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center">
                                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Success!</h2>
                        <p class="text-gray-600 mb-6">${message}</p>
                        <button onclick="this.closest('.fixed').remove()" class="w-full bg-rose-500 text-white py-2 px-4 rounded-lg hover:bg-rose-600 transition-colors">
                            Done
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        };

        window.showErrorModal = (message) => {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center modal-tertiary p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-xl w-full max-w-sm">
                    <div class="p-6 text-center">
                        <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <div class="w-12 h-12 bg-red-500 rounded-full flex items-center justify-center">
                                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </div>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Error</h2>
                        <p class="text-gray-600 mb-6">${message}</p>
                        <button onclick="this.closest('.fixed').remove()" class="w-full bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        };

        window.handleReviewSubmit = (hostName) => {
            if (!AppState.currentUser) {
                showRestrictedModal(hostName);
                return;
            }

            // Check if user has completed a booking with this host
            const hasCompletedBooking = AppState.bookings.some(booking => 
                booking.userId === AppState.currentUser.id && 
                booking.status === 'completed'
            );

            showRestrictedModal(hostName);
        };

        window.showRestrictedModal = (hostName) => {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center modal-quaternary p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-xl w-full max-w-sm">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">Review Restricted</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600 transition-colors">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <p class="text-gray-700 mb-6">
                            Only users who have been hosted by <strong>${hostName}</strong> can leave a review.
                        </p>
                        <button onclick="this.closest('.fixed').remove()" class="w-full bg-rose-500 text-white py-2 px-4 rounded-lg hover:bg-rose-600 transition-colors">
                            Understood
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        };

        // Image carousel functions
        let carouselStates = {};

        window.nextImage = (listingId) => {
            const listing = AppState.filteredListings.find(l => l.id === listingId);
            if (!listing || listing.images.length <= 1) return;
            
            if (!carouselStates[listingId]) carouselStates[listingId] = 0;
            carouselStates[listingId] = (carouselStates[listingId] + 1) % listing.images.length;
            updateCarousel(listingId);
        };

        window.prevImage = (listingId) => {
            const listing = AppState.filteredListings.find(l => l.id === listingId);
            if (!listing || listing.images.length <= 1) return;
            
            if (!carouselStates[listingId]) carouselStates[listingId] = 0;
            carouselStates[listingId] = (carouselStates[listingId] - 1 + listing.images.length) % listing.images.length;
            updateCarousel(listingId);
        };

        window.setImageIndex = (listingId, index) => {
            carouselStates[listingId] = index;
            updateCarousel(listingId);
        };

        const updateCarousel = (listingId) => {
            const carousel = document.getElementById(`carousel-${listingId}`);
            const index = carouselStates[listingId] || 0;
            if (carousel) {
                carousel.style.transform = `translateX(-${index * 100}%)`;
            }
            
            // Update dots
            const dots = carousel?.parentElement.querySelectorAll('.w-2.h-2');
            dots?.forEach((dot, i) => {
                if (i === index) {
                    dot.className = 'w-2 h-2 rounded-full transition-all bg-white';
                } else {
                    dot.className = 'w-2 h-2 rounded-full transition-all bg-white bg-opacity-50';
                }
            });
        };

        // Close dropdowns when clicking outside
        document.addEventListener('click', (event) => {
            const dropdown = document.getElementById('userDropdown');
            const button = event.target.closest('button[onclick="toggleUserDropdown()"]');
            
            if (dropdown && !button && !dropdown.contains(event.target)) {
                dropdown.classList.add('hidden');
            }
        });

        // Initialize EmailJS
        emailjs.init('W0Zng8g6Zol6lMWU9');

        // Initialize app
        initializeStorage();
        loadData();
        render();
    </script>
</body>
</html>
